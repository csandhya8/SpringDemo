
name: Deploy (3-choice + richer fail-fast validation)

on:
  workflow_dispatch:
    inputs:
      environment:
        description: "Environment"
        required: true
        type: choice
        options:
          - dev
          - staging
          - prod

      region:
        description: "Region"
        required: true
        type: choice
        options:
          - us-east
          - eu-west
          - ap-south

      service:
        description: "Service"
        required: true
        type: choice
        options:
          - api
          - web
          - worker

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - name: Fail-fast validation (rich rules)
        shell: bash
        run: |
          set -euo pipefail

          env="${{ github.event.inputs.environment }}"
          region="${{ github.event.inputs.region }}"
          service="${{ github.event.inputs.service }}"

          echo "::group::Inputs"
          echo "environment=$env"
          echo "region=$region"
          echo "service=$service"
          echo "::endgroup::"

          #############################################
          # Helper: contains check
          #############################################
          contains() {
            local needle="$1"; shift
            for x in "$@"; do [[ "$x" == "$needle" ]] && return 0; done
            return 1
          }

          #############################################
          # 1) Global disallows (hard bans)
          #############################################
          # Example: 'worker' is experimental; never allowed in eu-west
          if [[ "$service" == "worker" && "$region" == "eu-west" ]]; then
            echo "❌ Invalid: service=worker is not available in region=eu-west (global disallow)."
            exit 1
          fi

          # Example: prod cannot target ap-south due to compliance
          if [[ "$env" == "prod" && "$region" == "ap-south" ]]; then
            echo "❌ Invalid: environment=prod is not allowed in region=ap-south."
            exit 1
          fi

          #############################################
          # 2) Allowed regions per environment
          #############################################
          # dev: all regions; staging: us-east, eu-west; prod: us-east only
          if [[ "$env" == "staging" ]]; then
            if ! contains "$region" us-east eu-west; then
              echo "❌ Invalid: environment=staging supports regions: us-east, eu-west (got: $region)."
              exit 1
            fi
          elif [[ "$env" == "prod" ]]; then
            if ! contains "$region" us-east; then
              echo "❌ Invalid: environment=prod supports region: us-east only (got: $region)."
              exit 1
            fi
          fi

          #############################################
          # 3) Allowed services per environment
          #############################################
          # dev: api, web, worker; staging: api, web; prod: api only
          if [[ "$env" == "staging" ]]; then
            if ! contains "$service" api web; then
              echo "❌ Invalid: environment=staging supports services: api, web (got: $service)."
              exit 1
            fi
          elif [[ "$env" == "prod" ]]; then
            if ! contains "$service" api; then
              echo "❌ Invalid: environment=prod supports service: api only (got: $service)."
              exit 1
            fi
          fi

          #############################################
          # 4) Allowed services per region
          #############################################
          # us-east: api, web, worker; eu-west: api, web; ap-south: api only
          case "$region" in
            us-east)
              # all services allowed
              ;;
            eu-west)
              if ! contains "$service" api web; then
                echo "❌ Invalid: region=eu-west supports services: api, web (got: $service)."
                exit 1
              fi
              ;;
            ap-south)
              if ! contains "$service" api; then
                echo "❌ Invalid: region=ap-south supports service: api only (got: $service)."
                exit 1
              fi
              ;;
          esac

          #############################################
          # 5) Specific invalid triples (fine-grained rules)
          #############################################
          # Example: staging + ap-south + web not ready
          if [[ "$env" == "staging" && "$region" == "ap-south" && "$service" == "web" ]]; then
            echo "❌ Invalid: environment=staging region=ap-south service=web is not supported."
            exit 1
          fi

          # Example: dev + eu-west + worker blocked due to infra cost
          if [[ "$env" == "dev" && "$region" == "eu-west" && "$service" == "worker" ]]; then
            echo "❌ Invalid: dev in eu-west does not support service=worker."
            exit 1
          fi

          #############################################
          # 6) Specific invalid pairs (catch-all)
          #############################################
          invalid_pairs=(
            "prod|worker"
            "staging|worker"
          )
          for pair in "${invalid_pairs[@]}"; do
            IFS='|' read -r p_env p_service <<< "$pair"
            if [[ "$env" == "$p_env" && "$service" == "$p_service" ]]; then
              echo "❌ Invalid: environment=$env does not support service=$service."
              exit 1
            fi
          done

          echo "✅ Inputs validated successfully."

  build:
    needs: validate
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Build
        run: |
          echo "Building service='${{ github.event.inputs.service }}' for env='${{ github.event.inputs.environment }}' in region='${{ github.event.inputs.region }}'"
          # Add build commands here

  deploy:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Deploy
        run: |
          echo "Deploying ${{ github.event.inputs.service }} to ${{ github.event.inputs.environment }} in ${{ github.event.inputs.region }}"
          # Add deploy commands here
